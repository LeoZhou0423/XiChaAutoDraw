name: 自动打包并发布（Windows）

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（例如：v1.0）'
        required: true
        default: 'v1.0'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出源码（main 分支）
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 设置 Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装依赖
      shell: cmd
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if exist requirements.txt (
          pip install -r requirements.txt
        )

    - name: 打包程序到临时目录
      shell: cmd
      run: |
        pyinstaller --onefile --windowed --name "喜贴绘图工具" main.py
        mkdir _artifacts
        move "dist\喜贴绘图工具.exe" "_artifacts\"
        7z a "_artifacts\喜贴绘图-Windows.zip" "_artifacts\喜贴绘图工具.exe"

    - name: 准备发布分支并推送构建产物
      shell: bash
      env:
        VERSION: ${{ github.event.inputs.version }}
      run: |
        # 配置 Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 获取 releases 分支（如果不存在则创建空分支）
        git fetch origin releases:releases 2>/dev/null || git checkout --orphan releases
        
        # 切换到 releases 分支
        git checkout releases
        
        # 清理当前内容（只保留 .git）
        rm -rf .[^.]*
        rm -rf ..?*
        
        # 创建 releases/$VERSION 目录并复制 ZIP 和 EXE
        mkdir -p "releases/$VERSION"
        cp "../_artifacts/喜贴绘图-Windows.zip" "releases/$VERSION/"
        cp "../_artifacts/喜贴绘图工具.exe" "releases/$VERSION/"
        
        # 提交
        git add .
        git commit -m "chore: publish $VERSION"
        git push origin releases

    - name: 在 releases 分支上创建 tag
      shell: bash
      run: |
        git checkout releases
        git tag ${{ github.event.inputs.version }}
        git push origin ${{ github.event.inputs.version }}

    - name: 创建 GitHub Release 并上传附件
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: 喜贴自动绘制工具 ${{ github.event.inputs.version }}
        body: Windows 版本自动构建
        files: _artifacts/喜贴绘图-Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
