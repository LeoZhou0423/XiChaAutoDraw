name: Ubuntu Build
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/ubuntu.yml'

jobs:
  pyinstaller-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
    env: # å·¥ä½œçº§åˆ«çŽ¯å¢ƒå˜é‡
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Shanghai

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai apt-get update && apt-get install -y \
          sudo \
          openjdk-11-jdk \
          libx11-6 \
          libxcomposite1 \
          libxrandr2 \
          libxss1 \
          libgdk-pixbuf2.0-0 \
          libgtk-3-0 \
          xauth \
          libbz2-dev \
          libncurses5-dev \
          libffi-dev \
          libreadline-dev \
          libssl-dev \
          zlib1g-dev \
          build-essential \
          libsqlite3-dev \
          tk-dev \
          libgdbm-dev \
          libc6-dev \
          liblzma-dev \
          libncursesw5-dev \
          git \
          python3-pip \
          python-is-python3 \
          python3-venv \
          wget \
          unzip \
          && apt-get clean \
          && rm -rf /var/lib/apt/lists/*

      - name: Install pyenv and Python and Install Env and Build Executable
        shell: bash -l {0}
        run: |
          # å®‰è£…pyenv
          wget https://github.com/pyenv/pyenv/archive/refs/tags/v2.5.0.zip -O pyenv.zip
          unzip pyenv.zip
          mv pyenv-2.5.0/ ~/.pyenv
          rm pyenv.zip
          
          # é…ç½®pyenvçŽ¯å¢ƒå˜é‡
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
          echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
          
          # ç«‹å³ç”Ÿæ•ˆ
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init --path)"
          
          # å®‰è£…Python 3.9.9
          mkdir -p ~/.pyenv/cache
          wget https://www.python.org/ftp/python/3.9.9/Python-3.9.9.tar.xz -O ~/.pyenv/cache/Python-3.9.9.tar.xz
          pyenv install 3.9.9
          pyenv global 3.9.9
          rm -rf ~/.pyenv/cache/Python-*.tar.xz
          
          pyenv rehash
          
          # éªŒè¯å®‰è£…
          echo "å½“å‰Pythonè·¯å¾„: $(which python)"
          echo "å½“å‰Pythonç‰ˆæœ¬: $(python --version)"
          echo "å½“å‰pipç‰ˆæœ¬: $(pip --version)"
          
          # å®‰è£…ä¾èµ–å’ŒPyInstaller
          pip install --cache-dir=/tmp/pip-cache -r requirements.txt pyinstaller==5.7.0
          
          # æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
          python -m PyInstaller \
            --onefile \
            --console \
            --name=xicha-draw \
            --icon=logo.ico \
            --clean \
            --noconfirm \
            main.py

      - name: Verify build
        run: |
          cd $GITHUB_WORKSPACE
          pwd
          ls -al
          ls -al dist/
          tar -zcvf linux.zip dist/
          ls -la linux.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            linux.zip
            xicha-draw.spec

      - name: Create summary
        run: |
          echo "### ðŸŽ‰ Ubuntu Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "Python Version: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- Executable size: $(du -h dist/xicha-draw | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- Download URL: [Artifacts page](#)" >> $GITHUB_STEP_SUMMARY
          echo "âœ”ï¸ Executable **_(xicha-draw)_** uploaded successfully" >> $GITHUB_STEP_SUMMARY
