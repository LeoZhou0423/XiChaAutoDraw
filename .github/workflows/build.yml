name: 自动打包并发布（Windows）

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（例如：v1.0）'
        required: true
        default: 'v1.0'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码（带写权限）
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # ← 关键：提供 token 以支持后续 push/tag
        fetch-depth: 0                      # 拉取完整历史，便于打 tag
        fetch-tags: true                    # 获取所有 tags

    - name: 设置 Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if exist requirements.txt (
          pip install -r requirements.txt
        )

    - name: 打包程序
      run: |
        pyinstaller --onefile --windowed --name "喜贴绘图工具" main.py
        mkdir -p releases/${{ github.event.inputs.version }}
        move dist\"喜贴绘图工具.exe" releases/${{ github.event.inputs.version }}\
        7z a releases/${{ github.event.inputs.version }}\"喜贴绘图-Windows.zip" releases/${{ github.event.inputs.version }}\"喜贴绘图工具.exe"

    - name: 提交构建产物到仓库
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add releases/
        git commit -m "chore: add build for ${{ github.event.inputs.version }}"
        git push origin HEAD:main

    - name: 创建 Git Tag
      run: |
        git tag ${{ github.event.inputs.version }}
        git push origin ${{ github.event.inputs.version }}

    - name: 创建 GitHub Release 并上传 ZIP
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: 喜贴自动绘制工具 ${{ github.event.inputs.version }}
        body: Windows 版本自动构建
        files: releases/${{ github.event.inputs.version }}/喜贴绘图-Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
