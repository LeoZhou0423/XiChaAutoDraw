name: 自动打包并发布 Release（含 jsDelivr 加速支持）

on:
  # 手动触发（推荐）
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（如 v1.0）'
        required: true
        default: 'v1.0'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}  # 需要写权限

    - name: 设置 Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if exist requirements.txt (
          pip install -r requirements.txt
        )

    - name: 打包程序（Windows）
      run: |
        pyinstaller --onefile --windowed --name "喜贴绘图工具" main.py
        mkdir releases\${{ github.event.inputs.version }}
        move dist\"喜贴绘图工具.exe" releases\${{ github.event.inputs.version }}\
        7z a releases\${{ github.event.inputs.version }}\"喜贴绘图-Windows.zip" releases\${{ github.event.inputs.version }}\"喜贴绘图工具.exe"

    - name: 提交构建产物到 Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add releases/
        git commit -m "chore: add build artifacts for ${{ github.event.inputs.version }}"
        git push origin main

    - name: 创建 Git Tag
      run: |
        git tag ${{ github.event.inputs.version }}
        git push origin ${{ github.event.inputs.version }}

    - name: 创建 GitHub Release 并上传附件
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: Release ${{ github.event.inputs.version }}
        body: "自动构建版本 ${{ github.event.inputs.version }}"
        files: |
          releases/${{ github.event.inputs.version }}/喜贴绘图-Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
