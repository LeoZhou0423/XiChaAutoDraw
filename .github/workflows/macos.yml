name: macOS Build
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/macos.yml'

jobs:
  pyinstaller-build:
    runs-on: macos-13
    env:
      TZ: Asia/Shanghai
      PYTHON_VERSION: "3.9.9"
      MACOSX_DEPLOYMENT_TARGET: "10.15"

    steps:
      - uses: actions/checkout@v4
        with:
          architecture: x64

      - name: Install x86_64 Python via pyenv
        run: |
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          brew install openssl readline sqlite3 xz zlib tcl-tk
          
          # å®‰è£… pyenv
          brew install pyenv
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
          source ~/.bashrc
          
          # å¼ºåˆ¶å®‰è£… x86_64 ç‰ˆæœ¬ Python
          arch -x86_64 pyenv install $PYTHON_VERSION --verbose
          pyenv global $PYTHON_VERSION
          
          # éªŒè¯æž¶æž„
          python -c "import platform; print('Python Arch:', platform.machine())"
          which python

      - name: Set up Python PATH
        run: |
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH
          echo "$HOME/.pyenv/bin" >> $GITHUB_PATH

      - name: Verify Python
        run: |
          python --version
          pip --version
          python -c "import platform; print(platform.machine())"

      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install pyinstaller==5.7.0
          pip install -r requirements.txt

      - name: Build x86_64 executable
        run: |
          # å®Œå…¨æ¸…ç†çŽ¯å¢ƒ
          rm -rf __pycache__ build dist
          
          # å¼ºåˆ¶ x86_64 ç¼–è¯‘çŽ¯å¢ƒ
          export ARCHFLAGS="-arch x86_64"
          export CC="clang -arch x86_64"
          export CXX="clang++ -arch x86_64"
          
          # æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
          python -m PyInstaller \
            --windowed \
            --name=xicha-draw \
            --icon=logo.ico \
            --clean \
            --noconfirm \
            main.py
          
          # éªŒè¯æž¶æž„
          file dist/xicha-draw.app/Contents/MacOS/xicha-draw
          lipo -archs dist/xicha-draw.app/Contents/MacOS/xicha-draw

      - name: Prepare artifacts
        run: |
          mkdir -p dist/macos_bundle
          cp -r dist/xicha-draw.app dist/macos_bundle/
          
          # åˆ›å»º ZIP åŒ…
          cd dist && zip -r macos_bundle.zip macos_bundle/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-build
          path: dist/macos_bundle.zip

      - name: Create summary
        run: |
          echo "### ðŸ–¥ï¸ macOS Build Report" >> $GITHUB_STEP_SUMMARY
          echo "- Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- Binary Architecture: $(lipo -archs dist/xicha-draw.app/Contents/MacOS/xicha-draw)" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(du -h dist/xicha-draw.app | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          file dist/xicha-draw.app/Contents/MacOS/xicha-draw >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
